# pipe-3 – Grounded Architect

**Phase 3 of the AI-Driven PRD → Code Pipeline**

Given a PRD, repo DNA (phase-1) and impact analysis (phase-2), generates:

- `roadmap.json` – A step-wise, dependency-ordered technical roadmap
- `agent_prompt_pack.json` – One grounded coding-agent prompt per plan step
- `phase3_run.json` – Run metadata (inputs, timing, status)
- `roadmap.md` – Human-readable Markdown version of the roadmap

---

## Quick Start

```bash
# 1. Install dependencies
cd pipe-3
npm install

# 2. Build
npm run build

# 3. Run
node dist/index.js \
  --phase1Out ../out/pipe-1/<runId> \
  --phase2Out ../out/pipe-2/<runId> \
  --out       ../out/pipe-3
```

### All flags

| Flag | Alias | Required | Description |
|------|-------|----------|-------------|
| `--phase1Out` | `--p1` | ✅ | Path to the Phase-1 run output directory |
| `--phase2Out` | `--p2` | ✅ | Path to the Phase-2 run output directory |
| `--out` | `--o` | ✅ | Root output directory for Phase-3 runs |
| `--prd` | | | Explicit PRD file path (overrides path from `phase2_run.json`) |
| `--runId` | | | Override auto-generated run ID |
| `--engine` | | | Planning engine: `mock` (default; more planned) |

### Example

```bash
node dist/index.js \
  --phase1Out ../out/pipe-1/redx-admin-hub-1771431253020-20260218221415 \
  --phase2Out ../out/pipe-2/sample-run-001 \
  --out       ../out/pipe-3
```

---

## Pipeline Context

```
PRD file
   │
   ▼
pipe-1 (Repo Archaeologist)
   │  ./out/pipe-1/<runId>/
   │    indexes/files.jsonl
   │    project-dna/conventions.json
   │    project-dna/rules.json
   │    project-dna/tokens.json
   ▼
pipe-2 (Clarification Bridge)
   │  ./out/pipe-2/<runId>/
   │    impact_analysis.json
   │    clarifying_questions.json
   │    phase2_run.json
   ▼
pipe-3 (Grounded Architect)  ← you are here
      ./out/pipe-3/<runId>/
        roadmap.json
        agent_prompt_pack.json
        roadmap.md
        phase3_run.json
   ▼
pipe-4 (Agent Executor – not yet implemented)
```

---

## Output Structure

### `roadmap.json`

```json
{
  "prd": { "hash": "...", "source": "../out/sample_prd.md" },
  "generatedAt": "2026-02-19T20:04:37.000Z",
  "plan": [
    {
      "id": "step-types-001",
      "title": "Update shared TypeScript contracts",
      "area": "Types",
      "kind": "modify",
      "files": {
        "modify": ["src/types/auth.ts"],
        "create": [],
        "touch": ["src/redux/slices/AuthSlice.ts", "..."]
      },
      "dependsOnStepIds": [],
      "rationale": ["Type contracts must be established before services..."],
      "implementationChecklist": [
        "Open src/types/auth.ts and locate relevant interfaces",
        "..."
      ],
      "doneWhen": ["tsc reports 0 errors for all type files"]
    }
  ],
  "artifacts": {
    "filesToModify": ["src/types/auth.ts", "..."],
    "filesAffected": ["src/components/ui/avatar.tsx", "..."],
    "filesToCreate": [],
    "dependencies": []
  },
  "acceptanceCriteria": [
    "All TypeScript compilation errors are resolved (tsc exits 0)",
    "..."
  ],
  "verification": [
    { "type": "typecheck", "instructions": ["Run: npx tsc --noEmit", "..."] },
    { "type": "lint", "instructions": ["..."] },
    { "type": "unit_test", "instructions": ["..."] },
    { "type": "manual", "instructions": ["..."] }
  ],
  "risks": [
    {
      "severity": "high",
      "risk": "Auth changes can break access control for all users if misconfigured",
      "mitigation": ["Test with multiple user roles explicitly", "..."]
    }
  ],
  "openQuestions": [
    {
      "id": "q-auth-1",
      "question": "Does this feature require new authentication or authorisation rules?",
      "blocking": true,
      "whyThisMatters": ["Required for correct implementation", "..."]
    }
  ],
  "notes": ["Generated by MockPlanningEngine (deterministic mock)", "..."]
}
```

### `agent_prompt_pack.json`

```json
{
  "generatedAt": "2026-02-19T20:04:37.000Z",
  "prompts": [
    {
      "stepId": "step-types-001",
      "title": "Update shared TypeScript contracts",
      "system": "You are a senior software engineer working on a TypeScript + React codebase...",
      "context": {
        "prdSummary": "Feature X requires...",
        "impactedFiles": ["src/types/auth.ts"],
        "relevantRepoConventions": ["Use named exports over default exports..."],
        "tokensOrConstraints": ["--background: 0 0% 100%", "..."],
        "evidence": ["Matched PRD terms: auth, role, user", "..."]
      },
      "instructions": [
        "Open src/types/auth.ts and locate relevant interfaces",
        "Add new fields or types as required by the PRD",
        "..."
      ],
      "guardrails": [
        "DO NOT modify files outside the scope of this step",
        "DO NOT remove existing exported symbols without verifying there are no other consumers",
        "..."
      ],
      "deliverables": [
        "Modified file(s): src/types/auth.ts",
        "A unified diff or complete file contents of all changes"
      ]
    }
  ]
}
```

---

## Project Structure

```
pipe-3/
├── package.json
├── tsconfig.json
├── README.md
└── src/
    ├── index.ts                        CLI entry point
    ├── contracts/
    │   └── phase3.ts                   All public TypeScript types + interfaces
    └── phase3/
        ├── runPhase3.ts                Orchestrator (steps 1-4)
        ├── loadInputs.ts               Load phase-1 indexes and phase-2 outputs
        ├── derivePlan.ts               Assemble PlanningInput from loaded data
        ├── validatePlan.ts             Schema + grounding validation
        ├── renderMarkdown.ts           Roadmap → roadmap.md
        ├── ai/
        │   ├── PlanningEngine.ts       Re-exports the PlanningEngine interface
        │   └── MockPlanningEngine.ts   Deterministic heuristics-based engine
        └── utils/
            ├── classify.ts             Area slugs, file-path → area guessing
            ├── ordering.ts             Topological ordering (Kahn's algorithm)
            ├── text.ts                 PRD parsing, acceptance criteria extraction
            └── jsonschema.ts           Lightweight runtime validation
```

---

## Architecture: AI Engine Abstraction

The planning logic is isolated behind the `PlanningEngine` interface defined in `contracts/phase3.ts`:

```typescript
interface PlanningEngine {
  readonly name: string;
  plan(input: PlanningInput): Promise<PlanningOutput>;
}
```

To plug in a real LLM engine in Phase-4+, implement this interface and pass it to `runPhase3({ engine: myEngine })`.

### MockPlanningEngine

The `MockPlanningEngine` is **deterministic** – no network calls, no non-determinism. It:

- Reads `areaSummaries` from phase-2 to determine which areas are impacted
- Emits canonical plan steps using **area-specific templates** (Types → API → Auth → State → Hooks → Routing → UI → Styling → Tests)
- Applies **Kahn's topological sort** to order steps by dependency
- Extracts acceptance criteria from PRD headings / AC bullets, or synthesises defaults
- Derives risks from blast radius size and critical area presence (Auth / API / State)
- Grounds all file references to actual paths from the phase-1 file index
- Includes design tokens and coding rules from phase-1 in every agent prompt

---

## Step Ordering Logic

Steps are ordered so that contracts come before consumers:

```
Build/Config (0)
Types        (0)
Auth         (1)
API/Service  (1)
State        (2)
Hooks        (3)
Routing      (4)
UI           (4)
Styling      (5)
Tests        (6)
```

The `ordering.ts` module implements Kahn's algorithm, handling cycles gracefully by appending unresolved steps at the end.

---

## Acceptance Criteria Extraction

The engine looks for:
- Lines in a `## Acceptance Criteria` section
- `AC-N:` prefixed lines
- `GIVEN / WHEN / THEN` BDD scenarios

If none are found, it synthesises 5–10 criteria based on the impacted areas.

---

## Linter / Typecheck Sandbox (Mocked)

The `verification` section in `roadmap.json` includes deterministic instructions for:

| Type | Command |
|------|---------|
| `typecheck` | `npx tsc --noEmit` |
| `lint` | `npx eslint src --ext .ts,.tsx --max-warnings 0` |
| `unit_test` | `npm test` |
| `integration_test` | Service + auth flows (when applicable) |
| `manual` | Step-by-step browser QA checklist |

No real linting is executed at phase-3 generation time. Phase-4 would wire these into actual shell commands.
